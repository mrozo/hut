# HUT Design notes

Hut (Hackerspace unix toolkit) is set of tools intended to simplyfy management of hackerspace stuff up to the point of simplicyty, but no further. By "stuff" I mean: finances, membership, membership fees, keeping minimal data on the members in one place.

The design process of those tools was inspired by [The Art of Unix Programming by Eric Steven Raymond](http://catb.org/~esr/writings/taoup/html/) and the basic priciples guiding the design process are:

1. the user is a technical kind of person and the unix/linux is his/her work environment - there is no need to create elaborate web/gui applications for the hackers. Hackers love software that is easy to thinker with.
2. design protocols and file formats, not applications - make sure the code you create can be easly integrated with other software and the input/output data can be easly reasoned just by looking at it.
3. do one thing do it well and integrate well with other unix tools - do not try to create a standalone application that does ewverything, instead split it into parts and let the end hacker hack it by injecting his/her own software into the piplines.
4. prototype software before polishing it

## Functionality

Intended functionality of this toolkit includes:

1. Finance management
  1.1. Parsing bank statements
  1.2. checking membership fees
  1.3. manual adjustment of the fees (eg. either some member works hard or just need some financial leeway)
2. membership control
  2.1. adding/removing members
  2.2. members roles control 
3. simple file formats allowing easy scripting
4. additional policy layer that allows:
  3.1. setting up minimal membership value
  3.2. maximal forward membership hoarding - eg. even if a hacker send 100 000 $ twice, it will count as 3 month membership fee
  3.3. when to send missing membership notification
  3.4. hooks for creating/removing a member - eg. create a new user in the nextcloud instance when a member is added

## Finance management - parsing bank statements

Initially, this software is intended to be used by the Hackerspace Pomorze, so the only supported input file format for the financial statement parser is mt940 generated by the BNP Paribas (check ./doc/Struktura_wyciagu_MT940-1.pdf for the file format specification). In the future more file formats can be added by creating a parser and modifying `parse_transactions.sh` glue script.

The output file format of the `parse_transactions.sh` script is a [dsv file format](https://en.wikipedia.org/wiki/Delimiter-separated_values). If ones need an example of a dsv file, just chec `/etc/passwd`. Every record in the transactions dsv file is defined below:

```
<transaction date>;<account number>;<subject>;<address>;<amount>;<currency>;<transaction type>
```

Delimiter separating the fields is colon ';'.

where:
 * `<transaction date>` ISO 8601 date time without time zone
 * `<extra data>` string, should be transaction ID
 * `<account number>`
 * `<subject>` string
 * `<address>` string
 * `<amount>` decimal
 * `<currency>` string
 * `<transaction type>` Credit/Reversal Credit/Debit/Reversal Debit or other""")

## Reasons for using such file format

1. it can be parsed/filtered/processd using standard unix tools for example, one can use the following commands:
  1.1. `./parse_transactions.sh ./transactions_folder/* | awk -F ';' '{sum+=$6}' END {print sum}'` - will calculate current account balance
  1.2. `./parse_transactions.sh ./test_data/MT940/* | awk -F ';'  'tolower($4) ~ /sk..adk[ai]/ {print $4}'` - will print all transfers with subject matching `/sk..adk[ai]/` regexp pattern (In polish 'składka' means 'membership fee'. For some reason, `awk` treats polish characters like 'ł' as a two caracters - preasumambly its a problem with encoding polish characters in utf8 as two bytes and local settings).
  1.3. `cat "old_transactions.dsv" "new_transactions" | sort | uniq` - will merge two files containing transactions files.

## Users management

The user management is intended to keep track of the hackerspace members and theirs roles in the hackerspace (eg. member, honorary member). User module is intended to work on a dsv file with records defined as:

```
<hid>;<nick>;<entry date>;<email>;<name>;<last name>;<groups>
```

 * `hid` - hacker id - string
 * `nick` - preffered nick for the hacker 
 * `entry_date` - date, at witch the hacker has became a member in format "YYYY-MM-DD"
 * `email`- hackers email 
 * `name`
 * `last_name`
 * `groups` - list of comma separated groups the hacker is a member of

This file format is intended to be easy to use within scripts and glue logic. For example:

TODO

## User events

User events management module is intended to allow the admin/bord member to patch member fees in order to better reflect the real life. For exaple:

 * a member needs a one time membership fee cancelation due to some privte matters
 * a member, instead of paying membership fees for 3 months, bought some tool for the hackerspace
 * a member i so active and works so much, so he/she is reworded with a few "free" months of hckerspace membership


Event file format is a dsv file with colon ';' as the delimiter. Record format for this file is:

```
<date time>;<event type>;<comma-separted args>
```

Where:

 * `<date time>` - date at time, at which the event has ocuured, format YYYY-MM-DDTHH:MM:SS
 * `<comma-separated args>` - list of arguments for the event. For more informatio see `<event type>` documentation below:
 * `<event type>` - one of the event types:
   * `SetMembershipFees` - set membership fees count to specified number. Arguments : `<hacker id:string>`,`<number: integer>`
   * `AddMembershipFees` - add a specified number of membership fees to current count. Arguments `<hacker id:string>`,`<number: integer>`
   * `ClearMembershipFees` - set memberhip fees to 0. Arguments: `<hacker id:string>`


