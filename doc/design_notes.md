# HUT Design notes

Hut (Hackerspace unix toolkit) is set of tools intended to simplyfy management of hackerspace stuff up to the point of simplicyty, but no further. By "stuff" I mean: finances, membership, membership fees, keeping minimal data on the members in one place.

The design process of those tools was inspired by [The Art of Unix Programming by Eric Steven Raymond](http://catb.org/~esr/writings/taoup/html/) and the basic principles guiding the design process are:

1. the user is a technical kind of person and the unix/linux is his/her work environment - there is no need to create elaborate web/gui applications for the hackers. Hackers love software that is easy to thinker with.
2. design protocols and file formats, not applications - make sure the code you create can be easly integrated with other software and the input/output data can be easly reasoned just by looking at it.
3. do one thing do it well and integrate well with other unix tools - do not try to create a standalone application that does ewverything, instead split it into parts and let the end hacker hack it by injecting his/her own software into the piplines.
4. prototype software before polishing it

## Functionality

Intended functionality of this toolkit includes:

1. Finance management
  1.1. Parsing bank statements
  1.2. checking membership fees
  1.3. manual adjustment of the fees (eg. either some member works hard or just need some financial leeway)
2. membership control
  2.1. adding/removing members
  2.2. members roles control 
3. simple file formats allowing easy scripting
4. additional policy layer that allows:
  3.1. setting up minimal membership value
  3.2. maximal forward membership hoarding - eg. even if a hacker send 100 000 $ twice, it will count as 3 month membership fee
  3.3. when to send missing membership notification
  3.4. hooks for creating/removing a member - eg. create a new user in the nextcloud instance when a member is added

## Finance management - parsing bank statements

Initially, this software is intended to be used by the Hackerspace Pomorze, so the only supported input file format for the financial statement parser is mt940 generated by the BNP Paribas (check ./doc/Struktura_wyciagu_MT940-1.pdf for the file format specification). In the future more file formats can be added by creating a parser and modifying `parse_transactions.sh` glue script.

The output file format of the `parse_transactions.sh` script is a [dsv file format](https://en.wikipedia.org/wiki/Delimiter-separated_values). If ones need an example of a dsv file, just chec `/etc/passwd`. Every record in the transactions dsv file is defined below:

```
<transaction date>;<account number>;<subject>;<address>;<amount>;<currency>;<transaction type>
```

Delimiter separating the fields is colon ';'.

where:
 * `<transaction date>` ISO 8601 date time without time zone
 * `<extra data>` string, should be transaction ID
 * `<account number>`
 * `<subject>` string
 * `<address>` string
 * `<amount>` decimal
 * `<currency>` string
 * `<transaction type>` Credit/Reversal Credit/Debit/Reversal Debit or other""")

## Reasons for using such file format

1. it can be parsed/filtered/processd using standard unix tools for example, one can use the following commands:
  1.1. `./parse_transactions.sh ./transactions_folder/* | awk -F ';' '{sum+=$6}' END {print sum}'` - will calculate current account balance
  1.2. `./parse_transactions.sh ./test_data/MT940/* | awk -F ';'  'tolower($4) ~ /sk..adk[ai]/ {print $4}'` - will print all transfers with subject matching `/sk..adk[ai]/` regexp pattern (In polish 'składka' means 'membership fee'. For some reason, `awk` treats polish characters like 'ł' as a two caracters - preasumambly its a problem with encoding polish characters in utf8 as two bytes and local settings).
  1.3. `cat "old_transactions.dsv" "new_transactions" | sort | uniq` - will merge two files containing transactions files.

## Users management

The user management is intended to keep track of the hackerspace members and theirs roles in the hackerspace (eg. member, honorary member). User module is intended to work on a dsv file with records defined as:

```
<hid>;<nick>;<entry date>;<email>;<name>;<last name>;<groups>
```

 * `hid` - hacker id - string
 * `nick` - preffered nick for the hacker 
 * `entry_date` - date, at witch the hacker has became a member in format "YYYY-MM-DD"
 * `email`- hackers email 
 * `name`
 * `last_name`
 * `groups` - list of comma separated groups the hacker is a member of

This file format is intended to be easy to use within scripts and glue logic. For example:

TODO

## Hackerspace finance and membership events file 

Finance and membership events file format is intended to provide a simple way of managing all events related those subjects and merge such events from different sources.

Main expected sources of such events:
1. list of transactions from the bank account
2. list of transactions that happened outside the bank account 
3. list of manual patching events for the membership fees calculation

ad 3. Example events:
1. a member asked for a lower membership fee for a year due to some private stuff
2. a member has been reworded with honorary membership
3. there is some fuc** up with the papers
4. initially, when migrating to the HUT there might be some problems with migration.

### Hackerspace finance and membership events file format

the file format is `*.dsv` using colon `;` as a separator. Each line represents one event:

```
<date>;<event type>;<comma separated details>;<comment>
```

Where:
1. `<date>` - date of the event in format "YYYY-MM-DD"
2. `<event type>` - string, one of the event types: newMember, duesSet, duesAdd, duesSubstract (or duesSub), transaction
3. `<comma separated arguments>` - event depended list of details. Remember to escape all colons!
4. `<comment>` - a human readable comment explaining why that event exists. Will not be processed by the software, only displayed to the user. Can be left empty.

Event types (format is `<event name>;<arguments list>` ):

* `newMember;<hacker nick>` - a new member with `<hacker nick>` has joined the HS. Start counting member fees starting from the event date and value of 0.
* `duesSet;<hacker nick>,<value>` - set dues for the hacker to `<value>`
* `duesAdd;<hacker nick>,<value>` - increase paid dues number for the hacker by `<value>`
* `duesSub , dueSubstract;<hacker nick>,<value>` - decrease paid dues number for the hacker by `<value>`
* `transaction;<amount>,<source>,<subject>` - a financial event - an `<amount>` of money has been paid/given by the `<source>`. `<subject>` is used to pass banking transaction subject.
  * `<amount>` can be both positive (income) or negative (outcome)
  * `<source>` can be either account number or name or any string
  
### Example events files - manual events file

```
2019-02-01;newMember;hacker1;no comment
2019-02-01;newMember;hacker2;no comment
2019-02-01;newMember;hacker3;no comment
2019-02-01;newMember;hacker11;no comment
2020-01-01;dueSet;-1,hacker1;moving data from physical notepad to hut
2020-01-01;dueSet;0,hacker2;moving data from physical notepad to hut
2020-01-01;dueSet;3,hacker3;moving data from physical notepad to hut
2020-03-02;dueAdd,3,hacker2;hacker 2 bought a cnc machine for the hackerspace
2020-06-11;dueSet;0,hacker11;an old member has come back
2020-08-12;transaction;651,donation box,;income from the donation box
```

### Example events file - automatically generated transactions file from the bank account statements

```
2020-01-01;transaction,50,50 1000 2000 3000 4000 5000,membership fee for hacker1;transaction xxxxxx
2020-01-04;transaction,50,22 1000 2000 3000 4000 5000,membership fee for hacker2;transaction yyyyyy
2020-01-02;transaction,100,66 1000 2000 3000 4000 5000,membership fee for hacker3;transaction zzzzzz
```

## Processing flow

```
#!/bin/bash
# calculate membership dues for every hacker
parse_transactions.sh ./transactions/*.mt940 | ./transactions2events.py | classificator.sh -h ./hackers.dsv ./hause_rules.ini | ./merge.sh -stdin ./manual_patches.dsv ./donation_box.dsv > ./fees_report.dsv
# user provided script used to send membership dues information to via email 
./send_membership_dues_notifications.sh ./fees_report.dsv 
```



